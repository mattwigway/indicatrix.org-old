<!DOCTYPE html>
<html>
  <head>
    <title>GTFSrDB: Plumbing for GTFS-realtime&mdash;Indicatrix</title>

    <link rel="stylesheet" href="/lib/bootstrap/css/bootstrap.min.css" />
<link rel="stylesheet" href="/css/pygments.css" />
<link rel="stylesheet" href="/css/main.css" />


  </head>
  <body>
    <div class="navbar navbar-fixed-top">
  <div class="navbar-inner">
    <div class="container">
      <a class="brand indicatrix" href="/">Indicatrix</a>
      <ul class="nav">
        <li><a href="/projects">Projects</a></li>
        <li><a href="/copyright">Copyright</a></li>
        <li><a href="/archive">Archive</a></li>
      </ul>
    </div>
  </div>
</div>


    <div class="container">
      <div class="hero-unit">
        <h1><a href="/"><img src="/img/header.jpg" alt="Indicatrix" /></a></h1>
        <div class="vspacer"></div>
        <p>A blog about mapping, Python, GIS, JavaScript, transit, open data,
          planning, &c.</p>
      </div>

      <div class="row">
        <div class="span9">
          
<!-- link it b/c this template is used on the home page -->
<a href="/2011/09/02/gtfsrdb-plumbing-for-gtfs-realtime/">
  <h2>GTFSrDB: Plumbing for GTFS-realtime</h2>
</a>
<p class="author">by mattwigway on September 02, 2011</p>

<p>Over the last week I&rsquo;ve started a new project, GTFSrDB, which allows you to connect <a href="http://code.google.com/transit/realtime/">GTFS-realtime</a> with an SQL database, allowing app developers to use realtime data through SQL, just as easily as they use static data. Rather than worry about plumbing to connect GTFS and GTFS-realtime, they can focus on writing apps.</p>

<p>It accomplishes two primary tasks:</p>

<ol>
<li><p>Keeping a database up-to-date with the latest realtime data, and</p></li>
<li><p>Archiving historic real-time data.</p></li>
</ol>


<p>It&rsquo;s designed to work with <a href="http://code.google.com/p/gtfsdb/">GTFSdb</a>; it will coexist with static GTFS data in a database, so you can easily relate them. Keep in mind that if you update the GTFS data, you&rsquo;ll lose archived GTFSr data.</p>

<p>Here is an example query to find what stops have the largest delays (in seconds, for the TriMet system in Portland, OR):</p>

<div class="highlight"><pre><code class="sql"><span class="k">SELECT</span> <span class="n">stops</span><span class="p">.</span><span class="n">stop_id</span><span class="p">,</span> <span class="n">stops</span><span class="p">.</span><span class="n">stop_name</span><span class="p">,</span> <span class="n">stops</span><span class="p">.</span><span class="n">stop_lat</span><span class="p">,</span> <span class="n">stops</span><span class="p">.</span><span class="n">stop_lon</span><span class="p">,</span> <span class="n">stop_delays</span><span class="p">.</span><span class="k">avg</span>
  <span class="k">FROM</span> <span class="n">stops</span><span class="p">,</span> <span class="n">stop_delays</span>
  <span class="k">WHERE</span> <span class="n">stops</span><span class="p">.</span><span class="n">stop_id</span> <span class="o">=</span> <span class="n">stop_delays</span><span class="p">.</span><span class="n">stop_id</span>
  <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">avg</span> <span class="k">DESC</span><span class="p">;</span>
</code></pre>
</div>


<p>The stop_delays view looks like this:</p>

<div class="highlight"><pre><code class="sql"> <span class="k">SELECT</span> <span class="n">stop_times</span><span class="p">.</span><span class="n">stop_id</span><span class="p">,</span> <span class="k">avg</span><span class="p">(</span><span class="n">stop_time_updates</span><span class="p">.</span><span class="n">arrival_delay</span><span class="p">)</span> <span class="k">AS</span> <span class="k">avg</span>
   <span class="k">FROM</span> <span class="n">stop_time_updates</span><span class="p">,</span> <span class="n">stop_times</span><span class="p">,</span> <span class="n">trip_updates</span>
  <span class="k">WHERE</span> <span class="n">stop_times</span><span class="p">.</span><span class="n">trip_id</span><span class="p">::</span><span class="nb">text</span> <span class="o">=</span> <span class="n">trip_updates</span><span class="p">.</span><span class="n">trip_id</span><span class="p">::</span><span class="nb">text</span> <span class="k">AND</span> <span class="n">stop_times</span><span class="p">.</span><span class="n">stop_sequence</span> <span class="o">=</span> <span class="n">stop_time_updates</span><span class="p">.</span><span class="n">stop_sequence</span> <span class="k">AND</span> <span class="n">stop_time_updates</span><span class="p">.</span><span class="n">trip_update_id</span> <span class="o">=</span> <span class="n">trip_updates</span><span class="p">.</span><span class="n">oid</span>
  <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">stop_times</span><span class="p">.</span><span class="n">stop_id</span>
  <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">avg</span><span class="p">(</span><span class="n">stop_time_updates</span><span class="p">.</span><span class="n">arrival_delay</span><span class="p">)</span> <span class="k">DESC</span><span class="p">;</span>
</code></pre>
</div>


<p>(I had to pull in the trip_updates table for TriMet because they don&rsquo;t have a stop_id in their stop_time_updates; they instead specify trip_id and stop_sequence.)</p>

<p>(I&rsquo;ve removed the lat and lon columns from the following table for readability)</p>

<div class="highlight"><pre><code class="text"> stop_id |            stop_name            |         avg
---------+---------------------------------+----------------------
 10853   | Parkrose/ Sumner Transit Center | 473.8260869565217391
 7999    | NE 82nd &amp; MAX Overpass          | 350.3050847457627119
 9610    | Willow Creek Transit Center     | 310.2352941176470588
 5846    | Tigard Transit Center           | 260.2093023255813953
 12849   | 16200 Block SW Langer           | 244.6111111111111111
. . .
</code></pre>
</div>


<p>The code is available <a href="https://github.com/mattwigway/gtfsrdb">on GitHub</a>. Address any questions to the email on that page or to the contact link, above.</p>


<!-- again, b/c it's used on the home page -->
<a href="/2011/09/02/gtfsrdb-plumbing-for-gtfs-realtime/">Permalink to this post</a>


<div class="vspacer5"></div>
<h3>Related posts (autogenerated)</h3>
<ul>

  <li><a href="/2012/06/16/migrating-to-jekyll/">Migrating to Jekyll <i>(June 16, 2012)</i></a></li>

  <li><a href="cgs2012">Measuring Urban Mobility and Accessibility Using OpenTripPlanner Analyst <i>(April 29, 2012)</i></a></li>

  <li><a href="/2012/04/01/elevators-in-opentripplanner/">Elevators in OpenTripPlanner <i>(April 01, 2012)</i></a></li>

  <li><a href="/2012/04/01/bart-shocker-first-inner-core-infill-station-since-embarcadero/">BART Shocker: First Inner-Core Infill Station Since Embarcadero <i>(April 01, 2012)</i></a></li>

  <li><a href="/2012/03/31/conditionals-in-the-qgis-raster-calculator/">Conditionals in the QGIS raster calculator <i>(March 31, 2012)</i></a></li>

  <li><a href="/2012/03/03/conditional-labels-in-qgis/">Conditional Labels in QGIS <i>(March 03, 2012)</i></a></li>

  <li><a href="/2012/02/02/more-basemaps-in-qgis/">More Basemaps in QGIS <i>(February 02, 2012)</i></a></li>

  <li><a href="/2011/12/30/transit-to-everywhere/">Transit to Everywhere <i>(December 30, 2011)</i></a></li>

  <li><a href="/2011/12/23/as-you-may-have/">GitHub Image Diffs <i>(December 23, 2011)</i></a></li>

  <li><a href="/2011/12/13/shapefiles-in-openlayers/">Shapefiles in OpenLayers <i>(December 13, 2011)</i></a></li>


        </div>
        <div class="span3">
          <div class="barbox">
  <h3>Other Accounts</h3>
  <ul class="linklist">
    <li><a href="http://github.com/mattwigway">GitHub</a></li>
    <li><a href="http://twitter.com/mattwigway">Twitter</a></li>
  </ul>
</div>

<div class="barbox">
  <h3>Blogroll</h3>
  <ul class="linklist">
    <li>
      <a href="http://www.humantransit.org">Human Transit</a>
    </li>
    <li>
      <a title="Free and Open Source GIS" href="http://underdark.wordpress.com">UnderDark</a>
    </li>
    <li>
      <a href="http://transitappliance.org">Transit Appliance Development</a>
    </li>
    <li>
      <a href="http://portlandtransport.org">Portland Transport</a>
    </li>
    <li>
      <a href="http://thesource.metro.net">The Source&mdash;Los Angeles Metro</a>
    </li>
    <li>
      <a title="The Source en EspaÃ±ol" href="http://elpasajero.metro.net">El Pasajero&mdash;Metro de Los Angeles</a>
    </li>
    <li>
      <a href="http://howweroll.trimet.org">How we Roll&mdash;Portland TriMet</a>
    </li>
    <li>
      <a target="_blank" title="BRT for Silicon Valley." href="http://valleyrapid.org">Valley Rapid&mdash;VTA BRT</a>
    </li>
  </ul>
</div>

<div class="barbox">
  <a href="/feed/feed.xml">New posts <img src="/img/feed.png" /></a>
</div>

        </div>
      </div>

      <div class="vspacer5"></div>

      <div class="row">
  <!-- force it center -->
  <div class="span1">&nbsp;</div>
  <div class="span10">
    <p class="center">
      <a href="/copyright">CC-BY-SA 3.0</a> by Matt Conway, 2011-2012. Created with
      Jekyll and Bootstrap.
    </p>
  </div>
</div>

    </div>
    <script src="/lib/bootstrap/js/bootstrap.min.js"></script>

  </body>
