<!DOCTYPE html>
<html>
  <head>
    <title>Home&mdash;Indicatrix</title>

    <link rel="stylesheet" href="/lib/bootstrap/css/bootstrap.min.css" />
<link rel="stylesheet" href="/css/pygments.css" />
<link rel="stylesheet" href="/css/main.css" />


  </head>
  <body>
    <div class="navbar navbar-fixed-top">
  <div class="navbar-inner">
    <div class="container">
      <a class="brand indicatrix" href="/">Indicatrix</a>
      <ul class="nav">
        <li><a href="/projects">Projects</a></li>
        <li><a href="/copyright">Copyright</a></li>
        <li><a href="/archive">Archive</a></li>
      </ul>
    </div>
  </div>
</div>


    <div class="container">
      <div class="hero-unit">
        <h1><a href="/"><img src="/img/header.jpg" alt="Indicatrix" /></a></h1>
        <div class="vspacer"></div>
        <p>A blog about mapping, Python, GIS, JavaScript, transit, open data,
          planning, &c.</p>
      </div>

      <div class="row">
        <div class="span9">
          
  
  <!-- link it b/c this template is used on the home page -->
<a href="/2011/09/02/gtfsrdb-plumbing-for-gtfs-realtime/">
  <h2>GTFSrDB: Plumbing for GTFS-realtime</h2>
</a>
<p class="author">by mattwigway on September 02, 2011</p>

<p>Over the last week I&rsquo;ve started a new project, GTFSrDB, which allows you to connect <a href="http://code.google.com/transit/realtime/">GTFS-realtime</a> with an SQL database, allowing app developers to use realtime data through SQL, just as easily as they use static data. Rather than worry about plumbing to connect GTFS and GTFS-realtime, they can focus on writing apps.</p>

<p>It accomplishes two primary tasks:</p>

<ol>
<li><p>Keeping a database up-to-date with the latest realtime data, and</p></li>
<li><p>Archiving historic real-time data.</p></li>
</ol>


<p>It&rsquo;s designed to work with <a href="http://code.google.com/p/gtfsdb/">GTFSdb</a>; it will coexist with static GTFS data in a database, so you can easily relate them. Keep in mind that if you update the GTFS data, you&rsquo;ll lose archived GTFSr data.</p>

<p>Here is an example query to find what stops have the largest delays (in seconds, for the TriMet system in Portland, OR):</p>

<div class="highlight"><pre><code class="sql"><span class="k">SELECT</span> <span class="n">stops</span><span class="p">.</span><span class="n">stop_id</span><span class="p">,</span> <span class="n">stops</span><span class="p">.</span><span class="n">stop_name</span><span class="p">,</span> <span class="n">stops</span><span class="p">.</span><span class="n">stop_lat</span><span class="p">,</span> <span class="n">stops</span><span class="p">.</span><span class="n">stop_lon</span><span class="p">,</span> <span class="n">stop_delays</span><span class="p">.</span><span class="k">avg</span>
  <span class="k">FROM</span> <span class="n">stops</span><span class="p">,</span> <span class="n">stop_delays</span>
  <span class="k">WHERE</span> <span class="n">stops</span><span class="p">.</span><span class="n">stop_id</span> <span class="o">=</span> <span class="n">stop_delays</span><span class="p">.</span><span class="n">stop_id</span>
  <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">avg</span> <span class="k">DESC</span><span class="p">;</span>
</code></pre>
</div>


<p>The stop_delays view looks like this:</p>

<div class="highlight"><pre><code class="sql"> <span class="k">SELECT</span> <span class="n">stop_times</span><span class="p">.</span><span class="n">stop_id</span><span class="p">,</span> <span class="k">avg</span><span class="p">(</span><span class="n">stop_time_updates</span><span class="p">.</span><span class="n">arrival_delay</span><span class="p">)</span> <span class="k">AS</span> <span class="k">avg</span>
   <span class="k">FROM</span> <span class="n">stop_time_updates</span><span class="p">,</span> <span class="n">stop_times</span><span class="p">,</span> <span class="n">trip_updates</span>
  <span class="k">WHERE</span> <span class="n">stop_times</span><span class="p">.</span><span class="n">trip_id</span><span class="p">::</span><span class="nb">text</span> <span class="o">=</span> <span class="n">trip_updates</span><span class="p">.</span><span class="n">trip_id</span><span class="p">::</span><span class="nb">text</span> <span class="k">AND</span> <span class="n">stop_times</span><span class="p">.</span><span class="n">stop_sequence</span> <span class="o">=</span> <span class="n">stop_time_updates</span><span class="p">.</span><span class="n">stop_sequence</span> <span class="k">AND</span> <span class="n">stop_time_updates</span><span class="p">.</span><span class="n">trip_update_id</span> <span class="o">=</span> <span class="n">trip_updates</span><span class="p">.</span><span class="n">oid</span>
  <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">stop_times</span><span class="p">.</span><span class="n">stop_id</span>
  <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">avg</span><span class="p">(</span><span class="n">stop_time_updates</span><span class="p">.</span><span class="n">arrival_delay</span><span class="p">)</span> <span class="k">DESC</span><span class="p">;</span>
</code></pre>
</div>


<p>(I had to pull in the trip_updates table for TriMet because they don&rsquo;t have a stop_id in their stop_time_updates; they instead specify trip_id and stop_sequence.)</p>

<p>(I&rsquo;ve removed the lat and lon columns from the following table for readability)</p>

<div class="highlight"><pre><code class="text"> stop_id |            stop_name            |         avg
---------+---------------------------------+----------------------
 10853   | Parkrose/ Sumner Transit Center | 473.8260869565217391
 7999    | NE 82nd &amp; MAX Overpass          | 350.3050847457627119
 9610    | Willow Creek Transit Center     | 310.2352941176470588
 5846    | Tigard Transit Center           | 260.2093023255813953
 12849   | 16200 Block SW Langer           | 244.6111111111111111
. . .
</code></pre>
</div>


<p>The code is available <a href="https://github.com/mattwigway/gtfsrdb">on GitHub</a>. Address any questions to the email on that page or to the contact link, above.</p>


<!-- again, b/c it's used on the home page -->
<a href="/2011/09/02/gtfsrdb-plumbing-for-gtfs-realtime/">Permalink to this post</a>

  <div class="vspacer5"></div>

  
  <!-- link it b/c this template is used on the home page -->
<a href="/2011/08/06/fixed-position-dialogs-in-jquery-ui/">
  <h2>Fixed-position dialogs in jQuery UI</h2>
</a>
<p class="author">by mattwigway on August 06, 2011</p>

<p>I&rsquo;m working on a project where there is a long, scrolling page and I wanted to have a dialog that is draggable and resizeable that does not scroll away when the user scrolls down. As far as I could tell, there is no option to do this with jQuery UI&rsquo;s <a href="http://jqueryui.com/demos/dialog/">dialog</a> widget. But there is a quick workaround:</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">dialogDiv</span><span class="p">.</span><span class="nx">dialog</span><span class="p">().</span><span class="nx">parent</span><span class="p">().</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="s1">&#39;fixed&#39;</span><span class="p">);</span>
</code></pre>
</div>


<p>I use the parent because the dialog widget wraps the content in another &lt;div&gt; that contains the content and the other elements of the dialog box (title bar, &amp;c.).</p>

<p>UPDATE 6 Aug. 2011:</p>

<p>If the dialog box is resizeable, you also need to reset the position each time it is resized:</p>

<div class="highlight"><pre><code class="javascript"><span class="nx">mapDiv</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">&quot;dialogresize&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">dialogDiv</span><span class="p">.</span><span class="nx">parent</span><span class="p">().</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="s1">&#39;fixed&#39;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
</div>





<!-- again, b/c it's used on the home page -->
<a href="/2011/08/06/fixed-position-dialogs-in-jquery-ui/">Permalink to this post</a>

  <div class="vspacer5"></div>

  
  <!-- link it b/c this template is used on the home page -->
<a href="/2011/07/30/using-postgis-views-for-geoprocessing/">
  <h2>Using PostGIS Views for Geoprocessing</h2>
</a>
<p class="author">by mattwigway on July 30, 2011</p>

<p>Here&rsquo;s an efficiency improvement I&rsquo;ve recently come up with. I&rsquo;ve been working in QGIS on a hypothetical shuttle routing scenario, and one of the things I&rsquo;ve come up with to improve my efficiency is running my geoprocessing on-the-fly in PostGIS. Rather than run a buffer operation in fTools every time I change the routing (and then load the result to PostGIS), I simply created this view in my PostGIS database for the project:</p>

<div class="highlight"><pre><code class="sql"><span class="k">SELECT</span> <span class="n">routes</span><span class="p">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">routes</span><span class="p">.</span><span class="n">agency_id</span><span class="p">,</span> <span class="n">routes</span><span class="p">.</span><span class="n">route_short_name</span><span class="p">,</span>
       <span class="n">routes</span><span class="p">.</span><span class="n">route_long_name</span><span class="p">,</span> <span class="n">routes</span><span class="p">.</span><span class="n">route_desc</span><span class="p">,</span> <span class="n">routes</span><span class="p">.</span><span class="n">route_url</span><span class="p">,</span> <span class="n">routes</span><span class="p">.</span><span class="n">route_type</span><span class="p">,</span>
       <span class="n">routes</span><span class="p">.</span><span class="n">route_color</span><span class="p">,</span> <span class="n">routes</span><span class="p">.</span><span class="n">route_text_color</span><span class="p">,</span> <span class="n">routes</span><span class="p">.</span><span class="n">agency_name</span><span class="p">,</span> <span class="n">routes</span><span class="p">.</span><span class="n">potential</span><span class="p">,</span>
       <span class="n">st_buffer</span><span class="p">(</span><span class="n">routes</span><span class="p">.</span><span class="n">the_geom</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
   <span class="k">AS</span> <span class="n">the_geom</span>
   <span class="k">FROM</span> <span class="n">routes</span><span class="p">;</span>
</code></pre>
</div>


<p>Now, as I&rsquo;m editing, the buffer around the route automatically updates whenever I save. I had to project to a coordinate system because ST_Buffer uses SRID units for its buffer distance (I used a State Plane Coordinate System, with meters as the units). The query is pretty quick; I use an older P4 2.8GHz with 4GB of RAM as my primary GIS machine, and it calculates in under a second (the table is pretty simple, though). I run my Postgres server and QGIS on the same machine.</p>


<!-- again, b/c it's used on the home page -->
<a href="/2011/07/30/using-postgis-views-for-geoprocessing/">Permalink to this post</a>

  <div class="vspacer5"></div>

  
  <!-- link it b/c this template is used on the home page -->
<a href="/2011/07/25/accessing-gtfs-data-in-qgis/">
  <h2>Accessing GTFS Data in QGIS</h2>
</a>
<p class="author">by mattwigway on July 25, 2011</p>

<p>When you load GTFS data into PostGIS using <a href="http://code.google.com/p/gtfsdb/">gtfsdb</a>, you can&rsquo;t access that data in QGIS because the tables don&rsquo;t have a primary key in int4 format (the primary key is in text format).</p>

<p>If your transit system uses numeric ids in text format, an easy fix is running this against each of your tables:</p>

<div class="highlight"><pre><code class="sql"><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">stops</span> <span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">gid</span> <span class="nb">int</span><span class="p">;</span>
<span class="k">UPDATE</span> <span class="n">stops</span> <span class="k">SET</span> <span class="n">gid</span> <span class="o">=</span> <span class="n">stop_id</span><span class="p">::</span><span class="nb">int</span><span class="p">;</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">stops</span> <span class="k">ALTER</span> <span class="k">COLUMN</span> <span class="n">gid</span> <span class="k">SET</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">;</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">stops</span> <span class="k">ADD</span> <span class="k">CONSTRAINT</span> <span class="n">stops_gid_uniq</span> <span class="k">UNIQUE</span><span class="p">(</span><span class="n">gid</span><span class="p">);</span>
</code></pre>
</div>


<p>What this does is creates an integer ID field, populates it with the stop_id (or shape_id, &amp;c.) cast to an integer, then adds NOT NULL and UNIQUE constraints to the column. You can&rsquo;t add the constraints beforehand, because the column is initialized to NULL values. Remember you have to run these commands against every table you want to pull into QGIS directly, and remember to change stop_id to shape_id &amp;c.</p>

<p>The advantage to this approach is that the gids are the same as the stop_ids. The disadvantage of this approach is that it doesn&rsquo;t work with systems like <a href="http://bart.gov">BART</a> that have alphanumeric stop ids, like &lsquo;SHAY&rsquo; or &lsquo;24TH.&rsquo; If your system has a few ids like &lsquo;3104_A&rsquo;, don&rsquo;t worry that you won&rsquo;t notice them; Postgres won&rsquo;t cast that to a number but will throw an error like:</p>

<pre>
ERROR:  invalid input syntax for integer: "3104_A"
</pre>


<p>At least, that&rsquo;s what it did in Postgres 9.0.4.</p>

<p><strong>Update 2011-11-05:</strong></p>

<p>If your transit system has non-numeric IDs and you can&rsquo;t use the casting trick, you can create numerical IDs that are not tied to the Stop IDs like so:</p>

<div class="highlight"><pre><code class="sql"><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="o">&lt;</span><span class="k">table</span><span class="o">&gt;</span> <span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">nid</span> <span class="nb">SERIAL</span><span class="p">;</span>
</code></pre>
</div>


<p>Thanks, <a href="http://underdark.wordpress.com">underdark</a>!</p>


<!-- again, b/c it's used on the home page -->
<a href="/2011/07/25/accessing-gtfs-data-in-qgis/">Permalink to this post</a>

  <div class="vspacer5"></div>

  
  <!-- link it b/c this template is used on the home page -->
<a href="/2011/07/11/transit-appliance-at-oscon/">
  <h2>Transit Appliance at OSCON</h2>
</a>
<p class="author">by mattwigway on July 11, 2011</p>

<p>If any of this blog&rsquo;s readers will be attending OSCON July 25-29th in Portland, I suggest you check out the session being led by my codeveloper, <a href="http://chrissmith.us/">Chris Smith</a>, leader and founder of the <a href="http://transitappliance.org/">Transit Appliance</a> project, citizen activist and <a href="http://portlandtransport.com/">blogger extraordinaire</a>. He&rsquo;ll be talking about the open-source roots of the Transit Appliance project, and how the use of open data, hardware and software allows us to create arrival displays that are &ldquo;disruptively low cost.&rdquo; More information is available on the <a href="http://www.oscon.com/oscon2011/public/schedule/detail/18771">official page for the talk</a>.</p>


<!-- again, b/c it's used on the home page -->
<a href="/2011/07/11/transit-appliance-at-oscon/">Permalink to this post</a>

  <div class="vspacer5"></div>


<div class="paginator">
  
    
      <a href="/page3" class="previous">Newer Posts</a>
    
  

  
    <a href="/page5" class="next">Older Posts</a>
  
  <div class="clear"></div>
</div>

        </div>
        <div class="span3">
          <div class="barbox">
  <h3>Other Accounts</h3>
  <ul class="linklist">
    <li><a href="http://github.com/mattwigway">GitHub</a></li>
    <li><a href="http://twitter.com/mattwigway">Twitter</a></li>
  </ul>
</div>

<div class="barbox">
  <h3>Blogroll</h3>
  <ul class="linklist">
    <li>
      <a href="http://www.humantransit.org">Human Transit</a>
    </li>
    <li>
      <a title="Free and Open Source GIS" href="http://underdark.wordpress.com">UnderDark</a>
    </li>
    <li>
      <a href="http://transitappliance.org">Transit Appliance Development</a>
    </li>
    <li>
      <a href="http://portlandtransport.org">Portland Transport</a>
    </li>
    <li>
      <a href="http://thesource.metro.net">The Source&mdash;Los Angeles Metro</a>
    </li>
    <li>
      <a title="The Source en Español" href="http://elpasajero.metro.net">El Pasajero&mdash;Metro de Los Angeles</a>
    </li>
    <li>
      <a href="http://howweroll.trimet.org">How we Roll&mdash;Portland TriMet</a>
    </li>
    <li>
      <a target="_blank" title="BRT for Silicon Valley." href="http://valleyrapid.org">Valley Rapid&mdash;VTA BRT</a>
    </li>
  </ul>
</div>

<div class="barbox">
  <a href="/feed/feed.xml">New posts <img src="/img/feed.png" /></a>
</div>

        </div>
      </div>

      <div class="vspacer5"></div>

      <div class="row">
  <!-- force it center -->
  <div class="span1">&nbsp;</div>
  <div class="span10">
    <p class="center">
      <a href="/copyright">CC-BY-SA 3.0</a> by Matt Conway, 2011-2012. Created with
      Jekyll and Bootstrap.
    </p>
  </div>
</div>

    </div>
    <script src="/lib/bootstrap/js/bootstrap.min.js"></script>

  </body>
